/**
 * id: ipbQ
 * path: @bilibili-live/live-shadow
 */

function(require,module,exports) {
"use strict";async function e(e){const t=document.createElement("script"),n=document.getElementsByTagName("head")[0],a=new Promise((e,n)=>{t.onload=(()=>{e()}),t.onerror=n});t.src=e,null!=n&&n.appendChild(t),await a}function t(e,t){let n;return function(...a){void 0!==n&&window.clearTimeout(n),n=window.setTimeout(()=>{e.apply(this,a)},t)}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.createFlowerRain=m,exports.bodyMaskDetector=void 0;let n=null;const a={isSupported(){var e,t;return"OffscreenCanvas"in window&&(null!=(e=navigator.hardwareConcurrency)?e:-1)>4&&(null!=(t=navigator.deviceMemory)?t:-1)>4},async start(t,a,r){let i=window.LiveShadow;if(null==i&&(null==n&&(n=e("//s1.hdslb.com/bfs/blive-engineer-pkg/live-shadow/detect-body-mask.473689a2.umd.js")),await n,null==(i=window.LiveShadow)))throw Error("LiveShadow load failed");let d=await i.detectBodyMask(t,a,r),c=!1;async function l(){d(),null!=i&&(d=await i.detectBodyMask(t,a,r),c&&d())}const h=s(t,l),v=o(t,l);return()=>{c||(c=!0,h(),v(),d())}}};function o(e,t){if(!(e instanceof HTMLVideoElement))return()=>{};let n=e.videoWidth,a=e.videoHeight;const o=setInterval(async()=>{const{videoWidth:o,videoHeight:s}=e;o===n&&s===a||(n=o,a=s,t())},1e3);return()=>{clearInterval(o)}}function s(e,n){let{width:a,height:o}=e.getBoundingClientRect();const s=new ResizeObserver(t(async e=>{const t=e[0].contentRect;t.width===a&&t.height===o||(a=t.width,o=t.height,n())},1e3));return s.observe(e),()=>{s.disconnect()}}exports.bodyMaskDetector=a;const r=()=>{let e;self.onmessage=(t=>{"start"===t.data.event&&(self.clearInterval(e),e=self.setInterval(()=>{self.postMessage({})},16.7)),"stop"===t.data.event&&self.clearInterval(e)})},i=()=>{const e=new Blob([`(${r.toString()})()`]),t=URL.createObjectURL(e);return new Worker(t)},d=new Map;let c=1;const l=i();l.onmessage=(()=>{c+=1;for(const[e,t]of d.entries())c%e==0&&t.forEach(e=>e())});const h=(e,t=1)=>{var n;const a=null!=(n=d.get(t))?n:new Set;return a.add(e),d.set(t,a),1===d.size&&1===a.size&&l.postMessage({event:"start"}),()=>{a.delete(e),0===a.size&&d.delete(t),0===d.size&&(c=0,l.postMessage({event:"stop"}))}},v=new Image;v.src="https://i0.hdslb.com/bfs/activity-plat/static/20220801/6ad1a552c5f99f6be0ff1b0072d86e59/KhLcCEjHmx.png",v.crossOrigin="anymouse";const p=[[0,0,72,63],[75,0,51,67],[139,0,70,62]],u=()=>{};function m(e,t){const{width:n,height:o}=e,s=document.createElement("canvas");s.width=n,s.height=o;let r=0,i=22,d=!0,c=u,l=u,v=u,p=null;const m=s.getContext("2d"),g=[];async function M(){v==u&&a.isSupported()&&(v=await a.start(e,e=>{p=e},{type:"bitmap"}))}(async()=>{await M(),v(),v=u})();let y=u;return{canvas:s,sprinkle(){d=!1,c==u&&(l(),l=h(()=>w(m,g,{width:n,height:o,bodyMaskBitmap:p}),2),c=h(()=>{r+=1,d||r%i!=0||g.push(f({width:n,height:o}));for(let e=0;e<g.length;e+=1){const a=g[e];a.y.v>o?(g.splice(e,1),0===g.length&&(c(),c=u,m.clearRect(0,0,n,o),l(),l=u,v(),v=u,r=0,i=22,t.onEnded())):(a.x.v+=a.x.spd,a.y.v+=a.y.spd,a.rz.v=r*a.rz.spd*a.rz.d,a.rx.v=Math.sin(r*a.rx.spd)*a.rx.d,a.z.v=(Math.sin(r*a.z.spd)+3)/a.z.scaleRate)}},2)),M(),y(),y=h(()=>{d=!0,y()},300);const e=i-4;e<2||(i=e)}}}function w(e,t,n){e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,n.width,n.height),e.globalCompositeOperation="source-over";for(const a of t){const[t,n,o,s]=p[a.type];e.setTransform(1,0,0,1,a.x.v+o/2,a.y.v+s/2),e.rotate(a.rz.v),e.scale(1,a.rx.v),e.drawImage(v,t,n,o,s,-o/a.z.v/2,-s/a.z.v/2,o/a.z.v,s/a.z.v)}null!=n.bodyMaskBitmap&&(e.setTransform(1,0,0,1,0,0),e.globalCompositeOperation="destination-in",e.drawImage(n.bodyMaskBitmap,0,0,n.width,n.height))}function f(e){const t=e.height/720;return{x:{v:Math.random()*e.width-80,spd:(Math.random()+.5)*t},y:{v:-70,spd:(3*Math.random()+2)*t},z:{v:0,d:Math.random()>.5?1:-1,spd:Math.random()/30,scaleRate:t},rz:{v:2*Math.random()*Math.PI,d:Math.random()>.5?1:-1,spd:Math.random()/20},rx:{v:2*Math.random()*Math.PI,d:Math.random()>.5?1:-1,spd:Math.random()/40},type:Math.floor(3*Math.random())}}
}